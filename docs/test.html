<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh sửa dữ liệu biểu đồ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .node-form {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Chỉnh sửa dữ liệu biểu đồ</h1>
        
        <div id="node-editor">
            <!-- Các form chỉnh sửa node sẽ được thêm vào đây -->
        </div>
        
        <button id="add-node" class="btn btn-primary mb-3">Thêm node mới</button>
        <button id="save-data" class="btn btn-success mb-3">Lưu dữ liệu</button>
        <button onclick="goToChart()" class="btn btn-info mb-3">Xem biểu đồ</button>
        
        <div id="data-preview" class="mt-4">
            <h3>Xem trước dữ liệu:</h3>
            <pre id="json-preview"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let chartData = {
            'name': 'Môi Trường Á Châu',
            'title': 'general manager',
            'children': []
        };

        function createNodeForm(node, parentId = null) {
            const nodeId = 'node-' + Math.random().toString(36).substr(2, 9);
            const form = document.createElement('div');
            form.className = 'node-form';
            form.innerHTML = `
                <input type="hidden" name="id" value="${nodeId}">
                <input type="hidden" name="parentId" value="${parentId || ''}">
                <div class="mb-3">
                    <label class="form-label">Tên:</label>
                    <input type="text" class="form-control" name="name" value="${node.name || ''}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Tiêu đề:</label>
                    <input type="text" class="form-control" name="title" value="${node.title || ''}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Class:</label>
                    <input type="text" class="form-control" name="className" value="${node.className || ''}">
                </div>
                <button type="button" class="btn btn-danger remove-node">Xóa node</button>
                <button type="button" class="btn btn-info add-child">Thêm node con</button>
            `;
            
            form.querySelector('.remove-node').addEventListener('click', () => removeNode(form));
            form.querySelector('.add-child').addEventListener('click', () => addChildNode(nodeId));
            
            return form;
        }

        function addChildNode(parentId) {
            const childForm = createNodeForm({}, parentId);
            document.getElementById('node-editor').appendChild(childForm);
        }

        function removeNode(form) {
            form.remove();
        }

        function updateDataPreview() {
            const jsonPreview = document.getElementById('json-preview');
            jsonPreview.textContent = JSON.stringify(chartData, null, 2);
        }

        document.getElementById('add-node').addEventListener('click', () => {
            const rootForm = createNodeForm({});
            document.getElementById('node-editor').appendChild(rootForm);
        });

        document.getElementById('save-data').addEventListener('click', () => {
            const forms = document.querySelectorAll('.node-form');
            const newData = {
                'name': 'Môi Trường Á Châu',
                'title': 'general manager',
                'children': []
            };

            function processNode(node, parentId = null) {
                const children = [];
                forms.forEach(form => {
                    if (form.querySelector('[name="parentId"]').value === parentId) {
                        const childNode = {
                            name: form.querySelector('[name="name"]').value,
                            title: form.querySelector('[name="title"]').value,
                            className: form.querySelector('[name="className"]').value
                        };
                        const childId = form.querySelector('[name="id"]').value;
                        processNode(childNode, childId);
                        if (childNode.children && childNode.children.length === 0) {
                            delete childNode.children;
                        }
                        children.push(childNode);
                    }
                });
                if (children.length > 0) {
                    node.children = children;
                }
            }

            processNode(newData);
            chartData = newData;
            updateDataPreview();
            
            // Lưu dữ liệu vào localStorage
            localStorage.setItem('chartData', JSON.stringify(chartData));
            alert('Dữ liệu đã được lưu và sẵn sàng để hiển thị!');
        });

        // Khởi tạo form cho node gốc
        const rootForm = createNodeForm(chartData);
        document.getElementById('node-editor').appendChild(rootForm);
        updateDataPreview();

        function goToChart() {
            window.location.href = 'option-02.html';
        }
    </script>
</body>
</html>